name: 死链检测

on:
  schedule:
    - cron: '0 16 * * 0' # 每周日 16:00
  workflow_dispatch:

jobs:
  dead-link-detection:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装 Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. 安装 markdown-link-check
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      # 4. 检测死链
      - name: Check dead links
        id: deadlinks
        run: |
          # 查找 docs 下所有 Markdown 文件
          find docs -name "*.md" > md_files.txt

          # 初始化 deadlinks.txt
          touch deadlinks.txt

          # 循环检测
          while read file; do
            markdown-link-check "$file" -q >> deadlinks.txt || true
          done < md_files.txt

          # 判断是否有死链
          if grep -q "http" deadlinks.txt; then
            COLOR="#d9534f"  # 红色
          else
            COLOR="#28a745"  # 绿色
            echo "恭喜！没有检测到死链。" > deadlinks.txt
          fi

          # 生成 HTML 列表 (给每一行裹上 li 标签)
          HTML_LIST=$(sed 's/^/<li>/; s/$/<\/li>/' deadlinks.txt)

          # 输出变量给后续 step
          # 注意：这里使用了 EOF 写法，防止多行内容导致报错
          {
            echo "list_html<<EOF"
            echo "$HTML_LIST"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      # 5. 生成 HTML 邮件
      - name: Prepare email HTML
        run: |
          cp .github/deadlink_template.html email.html
          
          # 替换死链列表
          #以此种方式读取多行内容，防止斜杠干扰
          sed -i "s|{{DEADLINK_LIST}}|${{ steps.deadlinks.outputs.list_html }}|g" email.html
          
          # 替换颜色
          sed -i "s|{{COLOR}}|${{ steps.deadlinks.outputs.color }}|g" email.html
          
          # 【新增】自动替换年份
          sed -i "s|{{YEAR}}|$(date +'%Y')|g" email.html

      # 6. 发送邮件
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "博客死链检测结果"
          to: "2396768163@qq.com"
          from: "Github <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html