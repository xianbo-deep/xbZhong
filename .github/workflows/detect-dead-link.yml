name: 死链检测

on:
  schedule:
    - cron: '0 16 * * 0' # 每周日 16:00
  workflow_dispatch:

jobs:
  dead-link-detection:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装 Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. 安装 markdown-link-check
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      # 4. 检测死链 (已修复捕获逻辑)
      - name: Check dead links
        id: deadlinks
        run: |
          # 查找 docs 下所有 Markdown 文件
          find docs -name "*.md" > md_files.txt

          # 初始化文件
          touch raw_log.txt
          touch final_errors.txt
          touch formatted_list.txt

          # 替换占位符为真实的工作路径
          sed -i "s|__WORK_DIR__|$GITHUB_WORKSPACE|g" .markdown-link-check.json

          
          echo "开始扫描文件..."

          # 循环检测
          while read file; do
            markdown-link-check "$file" -c .markdown-link-check.json -q >> raw_log.txt 2>&1 || true
          done < md_files.txt

          
          # 匹配包含 [✖] 符号或 ERROR 字眼的行
          grep -E "\[✖\]|ERROR" raw_log.txt > final_errors.txt || true

          # 【修复点 3】根据过滤后的文件是否有内容来判断
          if [ -s final_errors.txt ]; then
            COLOR="#d9534f"  # 红色
            echo "Found dead links!"
            # 格式化为 HTML 列表
            sed 's/^/<li>/; s/$/<\/li>/' final_errors.txt > formatted_list.txt
          else
            COLOR="#28a745"  # 绿色
            echo "No dead links found."
            echo "<li>恭喜！没有检测到死链。</li>" > formatted_list.txt
          fi

          # 输出颜色变量
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      # 5. 生成 HTML 邮件
      - name: Prepare email HTML
        run: |
          cp .github/deadlink_template.html email.html
          
          # 插入列表 (使用 'r' 命令读取文件插入，最稳健的方法)
          sed -i "/{{DEADLINK_LIST}}/r formatted_list.txt" email.html
          sed -i "/{{DEADLINK_LIST}}/d" email.html
          
          # 替换颜色
          sed -i "s|{{COLOR}}|${{ steps.deadlinks.outputs.color }}|g" email.html
          
          # 自动替换年份
          sed -i "s|{{YEAR}}|$(date +'%Y')|g" email.html

      # 6. 发送邮件
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "博客死链检测结果"
          to: "2396768163@qq.com"
          from: "Github Action <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html