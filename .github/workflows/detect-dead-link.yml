name: 死链检测

on:
  schedule:
    - cron: '0 16 * * 0' # 每周日 16:00
  workflow_dispatch:

jobs:
  dead-link-detection:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装 Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. 安装 markdown-link-check
      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      # 4. 检测死链
      - name: Check dead links
        id: deadlinks
        run: |
          # 查找 docs 下所有 Markdown 文件 (根据实际情况调整目录)
          find docs -name "*.md" > md_files.txt

          # 初始化 deadlinks.txt
          touch deadlinks.txt

          # 循环检测，忽略 500 错误 (可选，防止网络波动误报)
          # -q 仅输出错误链接
          while read file; do
            echo "Checking $file..."
            markdown-link-check "$file" -q >> deadlinks.txt || true
          done < md_files.txt

          # 准备一个用于插入 HTML 的文件
          touch formatted_list.txt

          # 判断是否有死链
          if grep -q "http" deadlinks.txt; then
            COLOR="#d9534f"  # 红色
            echo "检测到死链，正在生成列表..."
            # 给每一行死链包裹 li 标签，并存入 formatted_list.txt
            # 使用 sed 特殊处理，防止 URL 中的字符导致问题
            sed 's/^/<li>/; s/$/<\/li>/' deadlinks.txt > formatted_list.txt
          else
            COLOR="#28a745"  # 绿色
            echo "<li>恭喜！没有检测到死链。</li>" > formatted_list.txt
          fi

          # 输出颜色变量 (列表内容直接走文件，不走变量)
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      # 5. 生成 HTML 邮件
      - name: Prepare email HTML
        run: |
          cp .github/deadlink_template.html email.html
          
          # 【关键修改】使用 sed 的 'r' 命令读取文件内容并插入，而不是用 's' 替换
          # 1. 在 {{DEADLINK_LIST}} 这一行后面插入 formatted_list.txt 的内容
          sed -i "/{{DEADLINK_LIST}}/r formatted_list.txt" email.html
          
          # 2. 删除原本的 {{DEADLINK_LIST}} 占位符行
          sed -i "/{{DEADLINK_LIST}}/d" email.html
          
          # 替换颜色
          sed -i "s|{{COLOR}}|${{ steps.deadlinks.outputs.color }}|g" email.html
          
          # 自动替换年份
          sed -i "s|{{YEAR}}|$(date +'%Y')|g" email.html

      # 6. 发送邮件
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "博客死链检测结果"
          to: "2396768163@qq.com"
          from: "Github Action <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html